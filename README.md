# 赤外線ドローンシューティングゲーム | ESP32C3 書き込み用プログラム

## 概要
2025年度理大祭用に作成した赤外線ドローンシューティングゲームの ESP32C3 書き込み用プログラム. Wrtten by [@Yuulis](https://github.com/Yuulis)

## 使用した製品
- Seeed Studio XIAO ESP32C3
    - 秋月電子 : https://akizukidenshi.com/catalog/g/g117454/ 
        - Wifi/Bluetooth 対応の小型マイコンボード
- 5mm 赤外線LED 940nm OSI5FU5111C-40
    - 秋月電子 : https://akizukidenshi.com/catalog/g/g103261/
        - 銃側の送信用として使用
- Vishay 赤外線レシーバ, 38kHz, 45m, 950nm, TSOP38238
    - https://jp.rs-online.com/web/p/ir-receivers/7085086?srsltid=AfmBOoosPm4UpcmzmcXFRsaUqPUHZ7Idp9js3vmy6M-xTeprJY5Ey0B7
- 2025年度の大会出場機体
    - 赤外線による自動投下機構を取り払ったもの
- 部室605のエアコン用リモコン
    - 38kHz の赤外線が送出される
    - 銃よりも射程が長く指向性も高いので, 初心者向け

## 環境構築
### 前提
- OS : Windows 11
- VSCode がインストール済みであること. WSLは使わず、**必ず Windows ネイティブ環境で動作させる**こと.

### VSCode の拡張機能インストール
以下の拡張機能をインストールする. そのほかはお好みで.
- PlatformIO IDE

### プロジェクトのクローン
1. 適当なフォルダに移動し, ターミナルを開く.
2. 以下のコマンドを実行し, プロジェクトをクローンする.
    ```bash
    git clone https://github.com/your-repository/drone-ir-shooting.git
    ```
3. VSCode でプロジェクトフォルダを開く.
    - `ファイル` > `フォルダーを開く` から `drone-ir-shooting` フォルダを選択

### 依存ライブラリのインストール
PlatformIO が自動的に必要なライブラリをインストールしてくれる.
1. VSCode の左側のアイコンから PlatformIO のアイコンをクリック. 「PIO Home」というタブが開く.
2. `PROJECT TASKS` > `seeed_xiao_esp32c3` > `General` > `Build` をクリック
3. 初回ビルド時は以下のライブラリが自動的にインストールされるはず :
    - `IRremoteESP8266` (赤外線通信ライブラリ)
    - `AsyncTCP-esphome` (非同期TCP通信)
    - `ESPAsyncWebServer-esphome` (Webサーバー)
    - `IRremote` (赤外線リモート制御)

## ハードウェアの接続
### 必要な部品
- Seeed Studio XIAO ESP32C3 × 1
- Vishay 赤外線レシーバ, 38kHz, 45m, 950nm, TSOP38238 × 1
- 5mm 赤外線LED 940nm OSI5FU5111C-40 × 1
- 抵抗 220Ω × 2 (LED用)
- ブレッドボード
- ジャンパワイヤ

### 配線図
```
ESP32C3          デバイス
--------         --------
D1 (GPIO2)   --> 赤外線レシーバ TSOP38238 の OUT ピン
D2 (GPIO3)   --> LED1 のアノード(+) (220Ω抵抗経由)
D3 (GPIO4)   --> LED2 のアノード(+) (220Ω抵抗経由)
GND          --> 赤外線レシーバの GND, LED のカソード(-)
3V3          --> 赤外線レシーバの VCC
```

### 配線手順
1. **赤外線レシーバの接続**
    - TSOP38238 の OUT ピンを ESP32C3 の D1 (GPIO2) に接続
    - TSOP38238 の GND を ESP32C3 の GND に接続
    - TSOP38238 の VCC を ESP32C3 の 3V3 に接続

2. **LED の接続**
    - LED1 のアノード(長い方)を 220Ω 抵抗経由で D2 (GPIO3) に接続
    - LED2 のアノード(長い方)を 220Ω 抵抗経由で D3 (GPIO4) に接続
    - LED1, LED2 のカソード(短い方)を GND に接続

## プログラムの書き込み
### ESP32C3 をPCに接続
1. USB Type-C ケーブルで ESP32C3 を PC に接続.
2. デバイスマネージャーで COM ポートを確認.

### ビルドとアップロード
1. VSCode の PlatformIO アイコンをクリック.
2. `PROJECT TASKS` > `seeed_xiao_esp32c3` > `General` > `Upload` をクリック(シリアルモニタを確認したい場合は, `Upload and Monitor` をクリック).
3. ビルドとアップロードが自動的に実行される.
4. アップロード完了後, ESP32C3 が自動的に再起動する.

### シリアルモニタでの動作確認
1. シリアルモニタで以下のようなメッセージが表示されれば成功:
    ```
    System Ready. Current Saved Score: 0
    ```

## 動作確認とテスト
### 1. 赤外線受信のテスト
1. シリアルモニタを開いた状態にする.
2. エアコンのリモコンを赤外線レシーバに向けてボタンを押す.
3. シリアルモニタに受信した赤外線コードが16進数で表示される(例) :
    ```
    0x5555555555555555
    ```
4. ヒット判定されると LED が点灯し, 以下のメッセージが表示される :
    ```
    HIT! Saved Score: 1
    ```

### 2. ゲームの進行
実際にゲームで遊ぶ場合は, [スコア表示用プログラム](https://github.com/RC-FlyingRobot/drone-ir-shooting-display)と組み合わせて使用する.

#### ゲーム開始
1. シリアルモニタで `START` と入力して Enter を押す
2. スコアが 0 にリセットされ, LED が 3 回点滅します
3. 以下のメッセージが表示されます:
    ```
    OK:STARTED
    ```

#### ゲーム中
1. 赤外線を受信すると LED が点灯し, スコアが加算されます
2. スコアは即座にフラッシュメモリに保存されます (電源喪失対策)

#### ゲーム終了
1. シリアルモニタで `FINISH` と入力して Enter を押す
2. 現在のスコアが返されます:
    ```
    SCORE:5
    ```

### 3. クールダウンタイムの確認
- 連続して赤外線を受信しても, 200ms のクールダウン時間があるため, 連打によるスコア不正は防止される.

### 4. 電源喪失時の挙動
1. ゲーム中に USB ケーブルを抜く
2. 再度接続してシリアルモニタを開く
3. 最後に保存されたスコアが表示されます:
    ```
    System Ready. Current Saved Score: 5
    ```

## トラブルシューティング
### アップロードに失敗する場合
1. ESP32C3 のリセットボタンを押しながら, アップロードを実行.
2. COM ポートが正しく認識されているか確認.
3. USB ケーブルがデータ転送対応か確認(**充電専用ケーブルでは書き込めない**ので注意).

### 赤外線を受信できない場合
1. 赤外線レシーバの配線を確認(特に VCC と GND の逆接続に注意).
2. 赤外線レシーバが 38kHz 対応であることを確認.
3. シリアルモニタで受信コードが表示されるか確認.
4. `HIT_CODES`配列に該当するコードが登録されているか確認.

### LED が点灯しない場合
1. LED の極性(アノード / カソード)を確認.
2. 抵抗値を確認(220Ω 推奨).
3. GPIO ピン番号が正しいか確認.

### スコアが保存されない場合
1. Preferences ライブラリが正しく動作しているか確認.
2. フラッシュメモリの容量を確認.

## プログラムのカスタマイズ
### ヒット判定コードの追加
`src/main.cpp`の`HIT_CODES`配列に, ヒット判定可能な新しい赤外線コードを追加できる :
```cpp
const uint64_t HIT_CODES[] = {
    0x5555555555555555, // エアコンのリモコン
    0x8F7807F,          // 赤外線(38kHz) 正規コード
    0xB301BD1F,         // 頻出パターン1
    0x55EEECD,          // 頻出パターン2
    0xCADB61A9,         // 頻出パターン3
    0xYOURCODE          // ← ここに追加
};
```

新しいコードを調べるには :
1. シリアルモニタを開く
2. 使いたいリモコンのボタンを ESP32C3 に向けて押す
3. 表示された16進数コードをコピーして配列に追加

### クールダウン時間の変更
```cpp
const unsigned long HIT_COOLDOWN = 200; // ミリ秒単位で変更可能
```

### LED ピンの変更
```cpp
const uint16_t LED_1_PIN = D2; // 好きなピンに変更可能
const uint16_t LED_2_PIN = D3; // 好きなピンに変更可能
```

